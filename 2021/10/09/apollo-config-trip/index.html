<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="零基础深入学习携程Apollo配置中心, 小张哥blog">
    <meta name="description" content="1:Apollo配置中心简介Apollo（阿波罗）是携程框架部门研发的配置管理平台，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性。服务端基于Spring Boot和Sprin">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>零基础深入学习携程Apollo配置中心 | 小张哥blog</title>
    <link rel="icon" type="image/png" href="/images/avatar.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7226904841878107" crossorigin="anonymous"></script>
<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="小张哥blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/avatar.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小张哥blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/avatar.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小张哥blog</div>
        <div class="logo-desc">
            
            北冥有鱼,其名为鲲,鲲之大,不知其几千里也;化而为鸟,其名为鹏.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">零基础深入学习携程Apollo配置中心</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/distributed-config/">
                                <span class="chip bg-color">distributed config</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Java-Apollo-config/" class="post-category">
                                Java Apollo config
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-10-09
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-10-12
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    23 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-Apollo配置中心简介"><a href="#1-Apollo配置中心简介" class="headerlink" title="1:Apollo配置中心简介"></a>1:Apollo配置中心简介</h2><p>Apollo（阿波罗）是携程框架部门研发的配置管理平台，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性。服务端基于Spring Boot和Spring Cloud开发，打包后可以直接运行，不需要额外安装Tomcat等应用容器。<br>为什么我们用了百度的disconf、spring-cloud-config携程还要另辟蹊径,研究出一套独有的Apollo呢？下面让我们通过开源配置中心对比矩阵一张图来进行解释这个问题:<br><img src="/images/apollo-config-trip/open-source-configuration-performance-comparison-matrix.jpg" alt="开源配置中心对比矩阵.jpg"><br>从性能对比图中我们不难看出,从功能特性、技术路线、可用性、易用性来说比其它开源配置中心是非常出色的(尤其是里面的灰度规则、namespace空间管理非常不错)。好,我们先从搭建开始讲起。</p>
<h2 id="2-注册中心阿波罗Apollo搭建"><a href="#2-注册中心阿波罗Apollo搭建" class="headerlink" title="2:注册中心阿波罗Apollo搭建"></a>2:注册中心阿波罗Apollo搭建</h2><p><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo">Apollo开源官网</a><br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki">Wiki</a> ☞ 一切的集成方式和使用方法都在这里<br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/issues">Issues</a> ☞ 如果期间有任何问题，请通过这里查找大部分解决方法<br>说明：我这里搭建的是1.3的服务版本,1.3.1在是目前最新的版本,相对于之前的版本增加了yml、yaml等多种配置文件的支持。<br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/releases">下载Releases版本</a><br>下载三个已经打好的安装包:<br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/releases/download/v1.3.0/apollo-adminservice-1.3.0-github.zip">apollo-adminservice-1.3.0-github.zip</a><br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/releases/download/v1.3.0/apollo-configservice-1.3.0-github.zip">apollo-configservice-1.3.0-github.zip</a><br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/releases/download/v1.3.0/apollo-portal-1.3.0-github.zip">apollo-portal-1.3.0-github.zip</a><br>2.1、基础环境：<br>JDK：1.8.0_161<br>Maven：3.5.2<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cdb">MySQL</a>：5.7.18<br>apollo：1.3.1<br>2.2 导入数据库文件 登录MySQL命令行，然后执行以下两个sql文件<br><a target="_blank" rel="noopener" href="https://github.com/nobodyiam/apollo-build-scripts/blob/master/sql/apolloportaldb.sql">界面管理</a><br><a target="_blank" rel="noopener" href="https://github.com/nobodyiam/apollo-build-scripts/blob/master/sql/apolloconfigdb.sql">配置中心</a><br>2.3、打包<br>分别将三个安装包进行解压</p>
<pre><code>unzip apollo-adminservice-1.3.0-github.zip -d ~/apollo/apollo-adminservice
unzip apollo-configservice-1.3.0-github.zip -d ~/apollo/apollo-configservice
unzip apollo-portal-1.3.0-github.zip -d ~/apollo/apollo-portal</code></pre>
<p>2.4、修改配置<br>分别进入apollo-adminservice、apollo-configservice的config进行配置application-github.properties 数据库配置,指向ApolloPortalDB库<br>进入apollo-portal的config目录编辑application-github.properties,将数据库指向ApolloPortalDB,并且编辑apollo-env.properties 将config meta server进行配置在里面<br>分别进行adminservice、configservice、apollo-portal等安装包的scripts目录,进行修改startup.sh脚本文件。<br>主要修改LOG_DIR(服务日志存储路径)、SERVER_PORT(服务启动端口,如果需要的话)以及jvm启动参数,<br>2.5、启动Apollo<br>apollo-configservice：进入scripts文件夹<br>执行脚本启动服务<br>./startup.sh<br>apollo-adminservice：进入scripts文件夹<br>切换到目录 apollo-adminservice/scripts<br>执行脚本启动服务<br>./startup.sh<br>apollo-portal：进入scripts文件夹<br>执行脚本启动服务<br>./startup.sh<br>2.6、访问Apollo配置中心页面<br>++<a href="http://localhost:8070++">http://localhost:8070++</a> ，默认用户名/密码参考☞ <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/Portal-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD">Portal 实现用户登录功能</a> 。<br><img src="/images/apollo-config-trip/apollo-admin-console-page.png" alt="apollo-admin-console-page.png"></p>
<h2 id="3-Apollo多环境搭建"><a href="#3-Apollo多环境搭建" class="headerlink" title="3:Apollo多环境搭建"></a>3:Apollo多环境搭建</h2><p>在搭建完成Apollo之后我们发现,默认就存在一个环境(默认为DEV),那么我们在实际项目使用过程中会同时存在多环境情况.(即:local/dev/test/prod…..)<br>阿波罗多注册环境配置搭建<br>3.1、多环境命名注意点<br> apollo目前支持的环境列表名称有哪些(<font color="red">切记环境名字不能瞎写,否则会找不到的,小张就在这里栽跟头了,随意写了TEST,结果portal启动报错</font>)？<br>详见apollo源码得知在:com.ctrip.framework.apollo.core.enums.Env枚举类<br>public enum Env{<br>LOCAL, DEV, BETA, FWS, FAT, UAT, LPT, PRO, TOOLS, UNKNOWN;<br>…<br>}<br>LOCAL - Local Development environment<br>DEV - Development environment<br>FWS - Feature Web Service Test environment<br>FAT - Feature Acceptance Test environment<br>LPT - Load and Performance Test environment<br>UAT - User Acceptance Test environment<br>PRO - Production environment<br><img src="/images/apollo-config-trip/apollo-multi-environment-naming.png" alt="apollo-Multi-environment-naming.png"><br>比如我需要增加一个FAT环境,那么需要新增一个config server、admin server、以及新的ApolloConfigDB库,其中config server、admin server的config下对应的数据库配置都指向新的ApolloConfigDB。<br>3.2、需要修改的表字段信息如下:<br>3.2.1、ApolloPortalDB库的ServerConfig表:<br><img src="/images/apollo-config-trip/apolloPortalDB-serviceConfig.png" alt="apolloPortalDB-serviceConfig.png"><br>针对不同环境的配置文件,在Apollo中创建不同的namespace时可以指定不同角色的用户来进行管理,方便不同角色的用户进行维护不同环境的配置。</p>
<h2 id="4-Apollo配置中心架构设计"><a href="#4-Apollo配置中心架构设计" class="headerlink" title="4:Apollo配置中心架构设计"></a>4:Apollo配置中心架构设计</h2><p>搭建完成之后我们一起来熟悉下Apollo配置中心的一个架构设计。<br>4.1、基础模型<br>如下即是Apollo的基础模型：<br>用户在配置中心对配置进行修改并发布<br>配置中心通知Apollo客户端有配置更新<br>Apollo客户端从配置中心拉取最新的配置、更新本地配置并通知到应用<br><img src="/images/apollo-config-trip/apollo-basic-architecture.png" alt="apollo-basic-architecture.png"><br>4.2、架构模块<br><img src="/images/apollo-config-trip/apollo-overall-architecture.png" alt="apollo-overall-architecture.png"><br>上图简要描述了Apollo的总体设计，我们可以从下往上看：</p>
<ul>
<li>Config Service提供配置的读取、推送等功能，服务对象是Apollo客户端</li>
<li>Admin Service提供配置的修改、发布等功能，服务对象是Apollo Portal（管理界面）</li>
<li>Config Service和Admin Service都是多实例、无状态部署，所以需要将自己注册到Eureka中并保持心跳</li>
<li>在Eureka之上我们架了一层Meta Server用于封装Eureka的服务发现接口</li>
<li>Client通过域名访问Meta Server获取Config Service服务列表（IP+Port），而后直接通过IP+Port访问服务，同时在Client侧会做load balance、错误重试</li>
<li>Portal通过域名访问Meta Server获取Admin Service服务列表（IP+Port），而后直接通过IP+Port访问服务，同时在Portal侧会做load balance、错误重试</li>
<li>为了简化部署，我们实际上会把Config Service、Eureka和Meta Server三个逻辑角色部署在同一个JVM进程中</li>
</ul>
<hr>
<p>4.3、Why Eureka<br>为什么我们采用Eureka作为服务注册中心，而不是使用传统的zk、etcd呢？大致总结了一下，有以下几方面的原因：</p>
<ul>
<li>它提供了完整的Service Registry和Service Discovery实现<br> 首先是提供了完整的实现，并且也经受住了Netflix自己的生产环境考验，相对使用起来会比较省心。</li>
<li>和Spring Cloud无缝集成<br>我们的项目本身就使用了Spring Cloud和Spring Boot，同时Spring Cloud还有一套非常完善的开源代码来整合Eureka，所以使用起来非常方便。<br>另外，Eureka还支持在我们应用自身的容器中启动，也就是说我们的应用启动完之后，既充当了Eureka的角色，同时也是服务的提供者。这样就极大的提高了服务的可用性。<br>这一点是我们选择Eureka而不是zk、etcd等的主要原因，为了提高配置中心的可用性和降低部署复杂度，我们需要尽可能地减少外部依赖。</li>
<li>Open Source<br>最后一点是开源，由于代码是开源的，所以非常便于我们了解它的实现原理和排查问题。</li>
</ul>
<p>4.4 各模块概要介绍<br>4.4.1 Config Service</p>
<ul>
<li>提供配置获取接口</li>
<li>提供配置更新推送接口（基于Http long polling）<br>服务端使用<a target="_blank" rel="noopener" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/request/async/DeferredResult.html">Spring DeferredResult</a>实现异步化，从而大大增加长连接数量<br>目前使用的tomcat embed默认配置是最多10000个连接（可以调整），使用了4C8G的虚拟机实测可以支撑10000个连接，所以满足需求（一个应用实例只会发起一个长连接）。</li>
<li>接口服务对象为Apollo客户端</li>
</ul>
<p>4.4.2 Admin Service</p>
<ul>
<li>提供配置管理接口</li>
<li>提供配置修改、发布等接口</li>
<li>接口服务对象为Portal</li>
</ul>
<p>4.4.3 Meta Server</p>
<ul>
<li>Portal通过域名访问Meta Server获取Admin Service服务列表（IP+Port）</li>
<li>Client通过域名访问Meta Server获取Config Service服务列表（IP+Port）</li>
<li>Meta Server从Eureka获取Config Service和Admin Service的服务信息，相当于是一个Eureka Client</li>
<li>增设一个Meta Server的角色主要是为了封装服务发现的细节，对Portal和Client而言，永远通过一个Http接口获取Admin Service和Config Service的服务信息，而不需要关心背后实际的服务注册和发现组件</li>
<li>Meta Server只是一个逻辑角色，在部署时和Config Service是在一个JVM进程中的，所以IP、端口和Config Service一致</li>
</ul>
<p>4.4.4 Eureka</p>
<ul>
<li>基于<a target="_blank" rel="noopener" href="https://github.com/Netflix/eureka">Eureka</a>和<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix</a>提供服务注册和发现</li>
<li>Config Service和Admin Service会向Eureka注册服务，并保持心跳</li>
<li>为了简单起见，目前Eureka在部署时和Config Service是在一个JVM进程中的（通过Spring Cloud Netflix）</li>
</ul>
<p>4.4.5 Portal</p>
<ul>
<li>提供Web界面供用户管理配置</li>
<li>通过Meta Server获取Admin Service服务列表（IP+Port），通过IP+Port访问服务</li>
<li>在Portal侧做load balance、错误重试</li>
</ul>
<p>4.4.6 Client</p>
<ul>
<li>Apollo提供的客户端程序，为应用提供配置获取、实时更新等功能</li>
<li>通过Meta Server获取Config Service服务列表（IP+Port），通过IP+Port访问服务</li>
<li>在Client侧做load balance、错误重试</li>
</ul>
<p>4.5 服务端设计<br>  4.5.1 发送ReleaseMessage的实现方式<br>Config Service有一个线程会每秒扫描一次ReleaseMessage表,看看是否有新的消息记录，参见<br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/blob/master/apollo-biz/src/main/java/com/ctrip/framework/apollo/biz/message/ReleaseMessageScanner.java">ReleaseMessageScanner</a><br>简要描述了NotificationControllerV2是如何得知有配置发布的，那NotificationControllerV2在得知有配置发布后是如何通知到客户端的呢？<br>实现方式如下：</p>
<ul>
<li>客户端会发起一个Http请求到Config Service的notifications/v2接口，也就是<a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/blob/master/apollo-configservice/src/main/java/com/ctrip/framework/apollo/configservice/controller/NotificationControllerV2.java">NotificationControllerV2</a>，参见<a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/blob/master/apollo-client/src/main/java/com/ctrip/framework/apollo/internals/RemoteConfigLongPollService.java">RemoteConfigLongPollService</a></li>
<li>NotificationControllerV2不会立即返回结果，而是通过<a target="_blank" rel="noopener" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/request/async/DeferredResult.html">Spring DeferredResult</a>把请求挂起</li>
<li>如果在60秒内没有该客户端关心的配置发布，那么会返回Http状态码304给客户端</li>
<li>如果有该客户端关心的配置发布，NotificationControllerV2会调用DeferredResult的<a target="_blank" rel="noopener" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/request/async/DeferredResult.html#setResult-T-">setResult</a>方法，传入有配置变化的namespace信息，同时该请求会立即返回。客户端从返回的结果中获取到配置变化的namespace后，会立即请求Config Service获取该namespace的最新配置。<br><img src="/images/apollo-config-trip/apollo-client-architecture.png" alt="apollo-client-architecture.png"><br>上图简要描述了Apollo客户端的实现原理：</li>
</ul>
<ol>
<li>客户端和服务端保持了一个长连接，从而能第一时间获得配置更新的推送。（通过Http Long Polling实现）</li>
<li>客户端还会定时从Apollo配置中心服务端拉取应用的最新配置。</li>
</ol>
<ul>
<li>这是一个fallback机制，为了防止推送机制失效导致配置不更新</li>
<li>客户端定时拉取会上报本地版本，所以一般情况下，对于定时拉取的操作，服务端都会返回304 - Not Modified</li>
<li>定时频率默认为每5分钟拉取一次，客户端也可以通过在运行时指定System Property: apollo.refreshInterval来覆盖，单位为分钟。</li>
</ul>
<ol start="3">
<li>客户端从Apollo配置中心服务端获取到应用的最新配置后，会保存在内存中</li>
<li>客户端会把从服务端获取到的配置在本地文件系统缓存一份</li>
</ol>
<ul>
<li>在遇到服务不可用或网络不通的时候，依然能从本地恢复配置</li>
</ul>
<ol start="5">
<li>应用程序可以从Apollo客户端获取最新的配置、订阅配置更新通知<br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%AE%BE%E8%AE%A1">更详细资料详见</a><h2 id="5-微服务中Apollo-java客户端的搭建使用"><a href="#5-微服务中Apollo-java客户端的搭建使用" class="headerlink" title="5:微服务中Apollo java客户端的搭建使用"></a>5:微服务中Apollo java客户端的搭建使用</h2></li>
<li>1、首先在微服务maven的pom项目中增加apollo的client 依赖<pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span>dependency<span class="token operator">></span>
 <span class="token operator">&lt;</span>groupId<span class="token operator">></span>com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>apollo<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
 <span class="token operator">&lt;</span>artifactId<span class="token operator">></span>apollo<span class="token operator">-</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
 <span class="token operator">&lt;</span>version<span class="token operator">></span><span class="token number">1.1</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></code></pre>
</li>
<li>2、在application启动类中指定@EnableApolloConfig配置项</li>
<li>3、启动应用中需要指定-Denv=dev参数</li>
<li>4、在yml中需要增加config server的服务地址配置以及serviceid配置项<pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">app</span><span class="token punctuation">:</span>
<span class="token key atrule">id</span><span class="token punctuation">:</span> SampleApp
<span class="token key atrule">apollo</span><span class="token punctuation">:</span>
<span class="token key atrule">meta</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//34.85.49.138<span class="token punctuation">:</span><span class="token number">8080</span>
<span class="token key atrule">bootstrap</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>
</li>
<li>5、注意事项<br>在多网卡机器的环境中,需要指定要注册到configServer的ip,避免内网ip或者受限制的网络ip注册到meta server中去,导致客户端获取不到元数据信息<br>可以在apollo-configservice 或者apollo-adminservice 的startup.sh中指定eureka 实例化注册的ip地址。参数信息如: -Deureka.instance.ip-address=${指定的IP} <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%88%86%E5%B8%83%E5%BC%8F%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97">详见官网资料</a></li>
<li>6、使用<font color="red">@ApolloConfigChangeListener</font>监听类进行监听配置项的改变<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ApolloConfigChangeListener</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">someOnChange</span><span class="token punctuation">(</span>ConfigChangeEvent changeEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//update injected value of batch if it is changed in Apollo</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changeEvent<span class="token punctuation">.</span><span class="token function">isChanged</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getIntProperty</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</li>
<li>7、使用简单样例<br>Java Config使用方式</li>
<li>7.1、新建配置类JavaConfigBean如下：</li>
</ol>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Java Config方式
 *
 * @author zyf
 * @create 2020-05-12 15:00
 **/</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaConfigBean</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${timeout:20}"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>


  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>5.7.2、新增访问端点</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//1.Java Config方式</span>
 <span class="token annotation punctuation">@Autowired</span>
 JavaConfigBean javaConfigBean<span class="token punctuation">;</span>


 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index1"</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> String <span class="token function">hello1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> javaConfigBean<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span></code></pre>
<p>Spring Boot提供了@ConfigurationProperties把配置注入到bean对象中。Apollo也支持这种方式，下面的例子会把redis.cache.expireSeconds和redis.cache.commandTimeout分别注入 到SampleRedisConfig的expireSeconds和commandTimeout字段中。<br>5.8.1、新增配置类SampleRedisConfig如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * ConfigurationProperties使用方式
 *
 * @author zyf
 * @create 2020-05-12 15:00
 **/</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"redis.cache"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleRedisConfig</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> expireSeconds<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> commandTimeout<span class="token punctuation">;</span>


  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setExpireSeconds</span><span class="token punctuation">(</span><span class="token keyword">int</span> expireSeconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>expireSeconds <span class="token operator">=</span> expireSeconds<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCommandTimeout</span><span class="token punctuation">(</span><span class="token keyword">int</span> commandTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>commandTimeout <span class="token operator">=</span> commandTimeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getExpireSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> expireSeconds<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCommandTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> commandTimeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java">新增访问端点
<span class="token comment" spellcheck="true">//2. ConfigurationProperties使用方式</span>
  <span class="token annotation punctuation">@Autowired</span>
  SampleRedisConfig sampleRedisConfig<span class="token punctuation">;</span>


  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index2"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> String <span class="token function">hello2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> sampleRedisConfig<span class="token punctuation">.</span><span class="token function">getCommandTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"--"</span><span class="token operator">+</span>sampleRedisConfig<span class="token punctuation">.</span><span class="token function">getExpireSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java">新增以下代码
<span class="token annotation punctuation">@ApolloConfigChangeListener</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">someOnChange</span><span class="token punctuation">(</span>ConfigChangeEvent changeEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//update injected value of batch if it is changed in Apollo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>changeEvent<span class="token punctuation">.</span><span class="token function">isChanged</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getIntProperty</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ApolloJsonValue</span>的使用
新增User如下：
<span class="token comment" spellcheck="true">/**
 * 用户
 *
 * @author zyf
 * @create 2020-05-12 15:00
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> String username<span class="token punctuation">;</span>
  <span class="token keyword">private</span> String password<span class="token punctuation">;</span>


  <span class="token keyword">public</span> String <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> username<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">public</span> String <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> password<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span>String password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
服务端新增配置
jsonBeanProperty<span class="token operator">=</span><span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token string">"username"</span><span class="token operator">:</span> <span class="token string">"john"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token operator">:</span> <span class="token string">"1234"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">"username"</span><span class="token operator">:</span> <span class="token string">"simon"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token operator">:</span> <span class="token string">"222132"</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
客户端获取配置
<span class="token comment" spellcheck="true">//4. @ApolloJsonValue使用</span>
<span class="token annotation punctuation">@ApolloJsonValue</span><span class="token punctuation">(</span><span class="token string">"${jsonBeanProperty:[]}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> List<span class="token operator">&lt;</span>User<span class="token operator">></span> anotherJsonBeans<span class="token punctuation">;</span>


<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index4"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  anotherJsonBeans<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"--"</span><span class="token operator">+</span>item<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>5.8.2、多配置文件</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>xes<span class="token punctuation">.</span>chn<span class="token punctuation">.</span>apollo<span class="token punctuation">.</span>service<span class="token punctuation">.</span>apollo<span class="token punctuation">.</span>impl<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>apollo<span class="token punctuation">.</span>Config<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>apollo<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ConfigChangeEvent<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>apollo<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ApolloConfig<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>apollo<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ApolloConfigChangeListener<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>apollo<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>EnableApolloConfig<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Logger<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>LoggerFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Scheduled<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>PostConstruct<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Set<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@EnableApolloConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"chn.application.properties"</span><span class="token punctuation">,</span> <span class="token string">"beibo.yml"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//@EnableApolloConfig("application.properties")</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggerConfigurationImpl</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>LoggerConfigurationImpl<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@ApolloConfig</span><span class="token punctuation">(</span><span class="token string">"chn.application.properties"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> Config commonProperties<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApolloConfig</span><span class="token punctuation">(</span><span class="token string">"beibo.yml"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> Config beiboYml<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${invokingServerPath.beibo.stuChangeUrl}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String stuChangeUrl<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//        System.out.println(gateway);</span>
<span class="token comment" spellcheck="true">//        System.out.println(config.getPropertyNames());</span>
<span class="token comment" spellcheck="true">//        Config config = ConfigService.getConfig("chn-beibo.yml"); //config instance is singleton for each namespace and is never null</span>
<span class="token comment" spellcheck="true">//        String someKey = "chn-beibo";</span>
<span class="token comment" spellcheck="true">//        String someDefaultValue = "1234567a";</span>
<span class="token comment" spellcheck="true">//        String value = config.getProperty(someKey, someDefaultValue);</span>
<span class="token comment" spellcheck="true">//        System.out.println(gateway);</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApolloConfigChangeListener</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"chn.application.properties"</span><span class="token punctuation">,</span> <span class="token string">"beibo.yml"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">someOnChange</span><span class="token punctuation">(</span>ConfigChangeEvent changeEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//update injected value of batch if it is changed in Apollo</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>changeEvent<span class="token punctuation">.</span><span class="token function">isChanged</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//            System.out.println(config.getIntProperty("timeout", 0));</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//    @Scheduled(fixedRate = 1000)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reportCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stuChangeUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token operator">&lt;</span>String<span class="token operator">></span> propertyNames<span class="token operator">=</span>commonProperties<span class="token punctuation">.</span><span class="token function">getPropertyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String stuChangeUrL<span class="token operator">=</span>beiboYml<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"invokingServerPath.beibo.stuChangeUrl"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String propertyName <span class="token operator">:</span> propertyNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>stuChangeUrL<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"stuChangeUrL:{}"</span><span class="token punctuation">,</span> stuChangeUrL<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"${"</span> <span class="token operator">+</span> propertyName <span class="token operator">+</span> <span class="token string">"}"</span><span class="token punctuation">,</span>commonProperties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<h2 id="6-带缓存与不带缓存Http接口从Apollo读取配置"><a href="#6-带缓存与不带缓存Http接口从Apollo读取配置" class="headerlink" title="6:带缓存与不带缓存Http接口从Apollo读取配置"></a>6:带缓存与不带缓存Http接口从Apollo读取配置</h2><p>6.1 通过带缓存的Http接口从Apollo读取配置<br>该接口会从缓存中获取配置，适合频率较高的配置拉取请求，如简单的每30秒轮询一次配置。</p>
<p>由于缓存最多会有一秒的延时，所以如果需要配合配置推送通知实现实时更新配置的话，请参考<a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#13-%E9%80%9A%E8%BF%87%E4%B8%8D%E5%B8%A6%E7%BC%93%E5%AD%98%E7%9A%84http%E6%8E%A5%E5%8F%A3%E4%BB%8Eapollo%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE">通过不带缓存的Http接口从Apollo读取配置</a>。<br>6.1.1 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#121-http%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E">Http接口说明</a><br>URL: {config_server_url}/configfiles/json/{appId}/{clusterName}/{namespaceName}?ip={clientIp}<br>Method: GET<br>参数说明:</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>参数值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>config_server_url</td>
<td>是</td>
<td>Apollo配置服务的地址</td>
<td></td>
</tr>
<tr>
<td>appId</td>
<td>是</td>
<td>应用的appId</td>
<td></td>
</tr>
<tr>
<td>namespaceName</td>
<td>是</td>
<td>如果没有新建过Namespace的话，传入application即可。 如果创建了Namespace，并且需要使用该Namespace的配置，则传入对应的Namespace名字。需要注意的是对于properties类型的namespace，只需要传入namespace的名字即可，如application。对于其它类型的namespace，需要传入namespace的名字加上后缀名，如datasources.json</td>
<td></td>
</tr>
<tr>
<td>ip</td>
<td>否</td>
<td>应用部署的机器ip</td>
<td>这个参数是可选的，用来实现灰度发布。 如果不想传这个参数，请注意URL中从?号开始的query parameters整个都不要出现。</td>
</tr>
</tbody></table>
<p>6.2 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#122-http%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E6%A0%BC%E5%BC%8F">Http接口返回格式</a><br>该Http接口返回的是JSON格式、UTF-8编码，包含了对应namespace中所有的配置项。<br>返回内容Sample如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token punctuation">{</span>
    <span class="token string">"portal.elastic.document.type"</span><span class="token operator">:</span><span class="token string">"biz"</span><span class="token punctuation">,</span>
    <span class="token string">"portal.elastic.cluster.name"</span><span class="token operator">:</span><span class="token string">"hermes-es-fws"</span>
<span class="token punctuation">}</span>
通过
<span class="token punctuation">{</span>config_server_url<span class="token punctuation">}</span><span class="token operator">/</span>configfiles<span class="token operator">/</span><span class="token punctuation">{</span>appId<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">{</span>clusterName<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">{</span>namespaceName<span class="token punctuation">}</span><span class="token operator">?</span>ip<span class="token operator">=</span><span class="token punctuation">{</span>clientIp<span class="token punctuation">}</span>可以获取到properties形式的配置</code></pre>
<p>6.3 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#123-%E6%B5%8B%E8%AF%95"> 测试</a><br>由于是Http接口，所以在URL组装OK之后，直接通过浏览器、或者相关的http接口测试工具访问即可。<br>6.4 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#13-%E9%80%9A%E8%BF%87%E4%B8%8D%E5%B8%A6%E7%BC%93%E5%AD%98%E7%9A%84http%E6%8E%A5%E5%8F%A3%E4%BB%8Eapollo%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE">通过不带缓存的Http接口从Apollo读取配置</a><br>该接口会直接从数据库中获取配置，可以配合配置推送通知实现实时更新配置。<br>6.5 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#131-http%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E">Http接口说明</a><br>URL: {config_server_url}/configs/{appId}/{clusterName}/{namespaceName}?releaseKey={releaseKey}&amp;ip={clientIp}<br>Method: GET<br>参数说明：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>参数值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>config_server_url</td>
<td>是</td>
<td>Apollo配置服务的地址</td>
<td></td>
</tr>
<tr>
<td>appId</td>
<td>是</td>
<td>应用的appId</td>
<td></td>
</tr>
<tr>
<td>clusterName</td>
<td>是</td>
<td>集群名</td>
<td>一般情况下传入 default 即可。 如果希望配置按集群划分，可以参考<a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%BA%94%E7%94%A8%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#%E4%B8%89%E9%9B%86%E7%BE%A4%E7%8B%AC%E7%AB%8B%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E">集群独立配置说明</a>做相关配置，然后在这里填入对应的集群名。</td>
</tr>
<tr>
<td>namespaceName</td>
<td>是</td>
<td>Namespace的名字</td>
<td>如果没有新建过Namespace的话，传入application即可。 如果创建了Namespace，并且需要使用该Namespace的配置，则传入对应的Namespace名字。需要注意的是对于properties类型的namespace，只需要传入namespace的名字即可，如application。对于其它类型的namespace，需要传入namespace的名字加上后缀名，如datasources.json</td>
</tr>
<tr>
<td>releaseKey</td>
<td>否</td>
<td>上一次的releaseKey</td>
<td>将上一次返回对象中的releaseKey传入即可，用来给服务端比较版本，如果版本比下来没有变化，则服务端直接返回304以节省流量和运算</td>
</tr>
<tr>
<td>ip</td>
<td>否</td>
<td>应用部署的机器ip</td>
<td>这个参数是可选的，用来实现灰度发布。</td>
</tr>
</tbody></table>
<p>6.5 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#132-http%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E6%A0%BC%E5%BC%8F">Http接口返回格式</a><br>该Http接口返回的是JSON格式、UTF-8编码。</p>
<p>如果配置没有变化（传入的releaseKey和服务端的相等），则返回HttpStatus 304，response body为空。<br>如果配置有变化，则会返回HttpStatus 200，response body为对应namespace的meta信息以及其中所有的配置项。<br>返回内容Sample如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token punctuation">{</span>
  <span class="token string">"appId"</span><span class="token operator">:</span> <span class="token string">"100004458"</span><span class="token punctuation">,</span>
  <span class="token string">"cluster"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
  <span class="token string">"namespaceName"</span><span class="token operator">:</span> <span class="token string">"application"</span><span class="token punctuation">,</span>
  <span class="token string">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"portal.elastic.document.type"</span><span class="token operator">:</span><span class="token string">"biz"</span><span class="token punctuation">,</span>
    <span class="token string">"portal.elastic.cluster.name"</span><span class="token operator">:</span><span class="token string">"hermes-es-fws"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"releaseKey"</span><span class="token operator">:</span> <span class="token string">"20170430092936-dee2d58e74515ff3"</span>
<span class="token punctuation">}</span></code></pre>
<p>6.6 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#133-%E6%B5%8B%E8%AF%95">测试</a><br>由于是Http接口，所以在URL组装OK之后，直接通过浏览器、或者相关的http接口测试工具访问即可。<br>6.7 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#14-%E5%BA%94%E7%94%A8%E6%84%9F%E7%9F%A5%E9%85%8D%E7%BD%AE%E6%9B%B4%E6%96%B0">应用感知配置更新</a><br>Apollo提供了基于Http long polling的配置更新推送通知，第三方客户端可以看自己实际的需求决定是否需要使用这个功能。<br>如果对配置更新时间不是那么敏感的话，可以通过定时刷新来感知配置更新，刷新频率可以视应用自身情况来定，建议在30秒以上。<br>如果需要做到实时感知配置更新（1秒）的话，可以参考下面的文档实现配置更新推送的功能。<br>6.8 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#141-%E9%85%8D%E7%BD%AE%E6%9B%B4%E6%96%B0%E6%8E%A8%E9%80%81%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"> 配置更新推送实现思路</a><br>这里建议大家可以参考Apollo的Java实现：<a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/blob/master/apollo-client/src/main/java/com/ctrip/framework/apollo/internals/RemoteConfigLongPollService.java">RemoteConfigLongPollService.java</a>，代码量200多行，总体上还是比较简单的。<br>6.8.1 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#1411-%E5%88%9D%E5%A7%8B%E5%8C%96">初始化</a><br>首先需要确定哪些namespace需要配置更新推送，Apollo的实现方式是程序第一次获取某个namespace的配置时就会来注册一下，我们就知道有哪些namespace需要配置更新推送了。<br>初始化后的结果就是得到一个notifications的Map，内容是namespaceName -&gt; notificationId（初始值为-1）。<br>运行过程中如果发现有新的namespace需要配置更新推送，直接塞到notifications这个Map里面即可。<br>6.8.2 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#1412-%E8%AF%B7%E6%B1%82%E6%9C%8D%E5%8A%A1">请求服务</a><br>有了notifications这个Map之后，就可以请求服务了。这里先描述一下请求服务的逻辑，具体的URL参数和说明请参见后面的接口说明。</p>
<ol>
<li>请求远端服务，带上自己的应用信息以及notifications信息</li>
<li>服务端针对传过来的每一个namespace和对应的notificationId，检查notificationId是否是最新的</li>
<li>如果都是最新的，则保持住请求60秒，如果60秒内没有配置变化，则返回HttpStatus 304。如果60秒内有配置变化，则返回对应namespace的最新notificationId, HttpStatus 200。</li>
<li>如果传过来的notifications信息中发现有notificationId比服务端老，则直接返回对应namespace的最新notificationId, HttpStatus 200。</li>
<li>客户端拿到服务端返回后，判断返回的HttpStatus</li>
<li>如果返回的HttpStatus是304，说明配置没有变化，重新执行第1步</li>
<li>如果返回的HttpStauts是200，说明配置有变化，针对变化的namespace重新去服务端拉取配置，参见1.3 通过不带缓存的Http接口从Apollo读取配置。同时更新notifications map中的notificationId。重新执行第1步。</li>
</ol>
<p>6.9 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#142-http%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E">Http接口说明</a><br>URL: {config_server_url}/notifications/v2?appId={appId}&amp;cluster={clusterName}&amp;notifications={notifications}<br>Method: GET<br>参数说明：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>参数值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>notifications</td>
<td>是</td>
<td>notifications信息</td>
<td>传入本地的notifications信息，注意这里需要以array形式转为json传入，如：[{“namespaceName”: “application”, “notificationId”: 100}, {“namespaceName”: “FX.apollo”, “notificationId”: 200}]。需要注意的是对于properties类型的namespace，只需要传入namespace的名字即可，如application。对于其它类型的namespace，需要传入namespace的名字加上后缀名，如datasources.json</td>
</tr>
<tr>
<td>config_server_url</td>
<td>是</td>
<td>Apollo配置服务的地址</td>
<td></td>
</tr>
<tr>
<td>clusterName</td>
<td>是</td>
<td>集群名</td>
<td>一般情况下传入 default 即可。 如果希望配置按集群划分，可以参考<a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%BA%94%E7%94%A8%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#%E4%B8%89%E9%9B%86%E7%BE%A4%E7%8B%AC%E7%AB%8B%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E">集群独立配置说明</a>做相关配置，然后在这里填入对应的集群名。</td>
</tr>
<tr>
<td>appId</td>
<td>是</td>
<td>应用的appId</td>
<td></td>
</tr>
</tbody></table>
<p>注1：由于服务端会hold住请求60秒，所以请确保客户端访问服务端的超时时间要大于60秒。<br>注2：别忘了对参数进行<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Percent-encoding">url encode</a><br>6.9.1 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#143-http%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E6%A0%BC%E5%BC%8F">Http接口返回格式</a><br>该Http接口返回的是JSON格式、UTF-8编码，包含了有变化的namespace和最新的notificationId。<br>返回内容Sample如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string">"namespaceName"</span><span class="token operator">:</span> <span class="token string">"application"</span><span class="token punctuation">,</span>
    <span class="token string">"notificationId"</span><span class="token operator">:</span> <span class="token number">101</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>6.9.2 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#144-%E6%B5%8B%E8%AF%95">测试</a><br>6.9.3 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/wiki/%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97#15-%E9%94%99%E8%AF%AF%E7%A0%81%E8%AF%B4%E6%98%8E">错误码说明</a><br>正常情况下，接口返回的Http状态码是200，下面列举了Apollo会返回的非200错误码说明。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>错误状态码</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>400 - Bad Request</td>
<td>客户端传入参数的错误，如必选参数没有传入等，客户端需要根据提示信息检查对应的参数是否正确。</td>
</tr>
<tr>
<td>2</td>
<td>404 - Not Found</td>
<td>接口要访问的资源不存在，一般是URL或URL的参数错误，或者是对应的namespace还没有发布过配置。</td>
</tr>
<tr>
<td>3</td>
<td>405 - Method Not Allowed</td>
<td>接口访问的Method不正确，比如应该使用GET的接口使用了POST访问等，客户端需要检查接口访问方式是否正确。</td>
</tr>
<tr>
<td>4</td>
<td>500 - Internal Server Error</td>
<td>其它类型的错误默认都会返回500，对这类错误如果应用无法根据提示信息找到原因的话，可以尝试查看服务端日志来排查问题。</td>
</tr>
</tbody></table>
<p>7.1 什么是yml占位符？举个例子如下:<br>我有2分配置文件,一份application.yml,为私有配置文件<br>该配置有个属性:<br>server:<br>  port: ${server.apollo-test-port}<br>另外有个公有配置文件<br>apollo-test.yml,该配置有个属性,<br>server:<br>  apollo-test-port: 10065</p>
<p>其中私有配置文件,使用到了占位符, 请问下,这种在阿波罗有实现吗?如果有,需要怎么做? 详见参考我之前在github中提交的issues,得到了作者的答复 <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/issues/1596">github issues</a><br>目前非properties格式是通过api方式获取的，ConfigService.getConfigFile,具体使用示例参照<br><a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/blob/master/apollo-demo/src/main/java/com/ctrip/framework/apollo/demo/api/ApolloConfigDemo.java#L52">github非properties配置文件读取样例</a><br>好了,到此就先总结这么多,后续还有更新的工作中躺过的坑或使用的问题我会实时更新到这里来,当然最主要的还是希望后续Apollo注册中心服务发挥出更出色的能力为我们的产品发挥出更大的可利用价值。</p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://xiaomozhang.github.io" rel="external nofollow noreferrer">小张哥</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://xiaomozhang.github.io/2021/10/09/apollo-config-trip/">http://xiaomozhang.github.io/2021/10/09/apollo-config-trip/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="http://xiaomozhang.github.io" target="_blank">小张哥</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/distributed-config/">
                                    <span class="chip bg-color">distributed config</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/pay/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/pay/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '030d444ad9269f7d8b2a',
        clientSecret: 'cf8eee8d0229cdefa0943263806746a2ea317004',
        repo: 'xiaomozhang.github.io',
        owner: 'xiaomozhang',
        admin: "xiaomozhang",
        id: '2021-10-09T11-32-21',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/10/10/java8-lambda-with-date-process/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="java8新特性原理以及实战应用-lambda函数式编程与日期篇">
                        
                        <span class="card-title">java8新特性原理以及实战应用-lambda函数式编程与日期篇</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1:简介目前截止2021年9月java最新的jdk版本为17,而我们目前大部分公司现在的java项目都还在运行的是java8的版本,对于我们目前的项目而言,java8已经能够满足我们大部分工作中的应用场景。而且截止目前为止oracle公司还
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-10-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Jdk8-lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-category">
                                    Jdk8 lambda表达式
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java8-lambda/">
                        <span class="chip bg-color">Java8 lambda</span>
                    </a>
                    
                    <a href="/tags/Stream-Programming/">
                        <span class="chip bg-color">Stream Programming</span>
                    </a>
                    
                    <a href="/tags/LocalDate%E3%80%81LocalTime%E3%80%81Instant%E3%80%81Duration/">
                        <span class="chip bg-color">LocalDate、LocalTime、Instant、Duration</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/10/08/golang-log-with-fmt-different/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="golang日志篇-log与fmt区别">
                        
                        <span class="card-title">golang日志篇-log与fmt区别</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            最近在排查golang服务上报丢失日志的问题。发现服务中记录日志的操作大部分使用都是golang log包下的工具类进行操作的,那么log与fmt二者有什么区别？通过下面的样例来具体了解下二者的区别。
1:线程安全层面我们可以运行以下示例

                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-10-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Golang%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA/" class="post-category">
                                    Golang日志输出
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Golang-log-Golang-fmt/">
                        <span class="chip bg-color">Golang log Golang fmt</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2017</span>
            <a href="http://xiaomozhang.github.io" target="_blank">小张哥</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">163.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2017";
                    var startMonth = "09";
                    var startDate = "5";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/xiaomozhang" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:zhangyide7@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/yide.zhang.3998" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/yide.zhang.3998" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/zhangyide7" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/zhangyide7" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1678658351" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1678658351" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
